{"version":3,"sources":["Chat.js"],"names":["Utils","require","RoomInfo","cc","Class","extends","Component","properties","listRoot","default","type","Node","chatListRoot","tipRoot","tipLabel","Label","toUserLabel","curUserLabel","curInput","EditBox","start","self","pomelo","on","data","log","from","target","msg","addMessage","tip","user","list","players","info","name","push","getComponent","refreshList","index","i","length","splice","targetName","reason","active","string","myName","setTargetName","update","dt","onBtnSendClick","route","roomId","reqData","rid","content","printObj","request","chatLogs","toName","act1","fadeIn","act2","fadeOut","seq","sequence","runAction"],"mappings":"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","file":"Chat.js","sourceRoot":"../../../../assets/Script","sourcesContent":["// Learn cc.Class:\n//  - [Chinese] http://www.cocos.com/docs/creator/scripting/class.html\n//  - [English] http://www.cocos2d-x.org/docs/editors_and_tools/creator-chapters/scripting/class/index.html\n// Learn Attribute:\n//  - [Chinese] http://www.cocos.com/docs/creator/scripting/reference/attributes.html\n//  - [English] http://www.cocos2d-x.org/docs/editors_and_tools/creator-chapters/scripting/reference/attributes/index.html\n// Learn life-cycle callbacks:\n//  - [Chinese] http://www.cocos.com/docs/creator/scripting/life-cycle-callbacks.html\n//  - [English] http://www.cocos2d-x.org/docs/editors_and_tools/creator-chapters/scripting/life-cycle-callbacks/index.html\n\nvar Utils = require('Utils')\nvar RoomInfo = require('RoomInfo')\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        listRoot: {\n            default: null,\n            type: cc.Node,\n        },\n        chatListRoot: {\n            default: null,\n            type: cc.Node,\n        },\n        tipRoot: {\n            default: null,\n            type: cc.Node,\n        },\n        tipLabel: {\n            default: null,\n            type: cc.Label,\n        },\n        toUserLabel: {\n            default: null,\n            type: cc.Label,\n        },\n        curUserLabel: {\n            default: null,\n            type: cc.Label,\n        },\n        curInput: {\n            default: null,\n            type: cc.EditBox,\n        }\n    },\n\n    // LIFE-CYCLE CALLBACKS:\n\n    // onLoad () {},\n\n    start () {\n        //wait message from the server.\n        var self = this;\n        pomelo.on('onChat', function(data) {\n            cc.log(\"onChat\", data.from, data.target, data.msg);\n            self.addMessage(data.from, data.target, data.msg);\n            // if(data.from !== RoomInfo.myName)\n                self.tip(data.from);\n        });\n\n        //update user list\n        pomelo.on('onAdd', function(data) {\n            var user = data.user;\n            cc.log('online', user);\n            var list = RoomInfo.players;\n            var info = {};\n            info.name = user;\n            list.push(info);\n            self.listRoot.getComponent(\"ListViewCtrl\").refreshList();\n        });\n\n        //update user list\n        pomelo.on('onLeave', function(data) {\n            var user = data.user;\n            cc.log('offline', user);\n            var list = RoomInfo.players;\n            var index;\n            for (i = 0; i < list.length; i++) {\n                var info = list[i];\n                if (info.name == user)\n                {\n                    index = i;\n                    break;\n                }\n            }\n            if (index) {\n                cc.log(\"onLeave\", user, index);\n                list.splice(index, 1);\n            }\n            self.listRoot.getComponent(\"ListViewCtrl\").refreshList();\n            if (user == RoomInfo.targetName) {\n                self.tip(\"你的私聊对象下线了\");\n            }\n        });\n\n        //handle disconect message, occours when the client is disconnect with servers\n        pomelo.on('disconnect', function(reason) {\n            cc.log(\"on disconnect\", reason);\n        });\n\n        this.tipRoot.active = false;\n\n        this.curUserLabel.string = RoomInfo.myName;\n        this.toUserLabel.string = \"\";\n        cc.log(\"RoomInfo.targetName\", RoomInfo.targetName, RoomInfo.targetName == \"*\");\n        if (RoomInfo.targetName == \"*\") {\n            cc.log(\"!!!!!\");\n        }\n        this.setTargetName(\"所有人\");\n        //init list\n        this.listRoot.getComponent(\"ListViewCtrl\").refreshList();\n\n        this.tip();\n    },\n\n    update (dt) {\n    \n    },\n\n    onBtnSendClick: function() {\n        var route = \"chat.chatHandler.send\";\n        var msg = this.curInput.string;\n\n        var list = RoomInfo.players;\n        var index;\n        for (i = 0; i < list.length; i++) {\n            var info = list[i];\n            if (info.name == RoomInfo.targetName)\n            {\n                index = i;\n                break;\n            }\n        }\n        cc.log(\"RoomInfo.targetName\", RoomInfo.targetName);\n        cc.log(RoomInfo.targetName === '*');\n        cc.log(\"???!@#!@#?!@#?!@?#?\");\n        cc.log(RoomInfo.targetName === \"*\");\n        if (RoomInfo.targetName != \"*\" && !index) {\n            this.tip(RoomInfo.targetName + \"不在线!\");\n            return;   \n        }\n        \n        var self = this;\n        var target = RoomInfo.targetName;\n        var from = RoomInfo.myName;\n        cc.log(RoomInfo.roomId, from, target, msg);\n\t\tif(msg !== \"\") {\n            var reqData = {\n\t\t\t\trid: RoomInfo.roomId,\n\t\t\t\tcontent: msg,\n\t\t\t\tfrom: from,\n\t\t\t\ttarget: target,\n            };\n            Utils.printObj(reqData);\n\t\t\tpomelo.request(route, reqData, function(data) {\n                // cc.log(data);\n                Utils.printObj(data);\n                self.curInput.string = \"\";\n                if (target != '*' && target != RoomInfo.myName) {\n                    self.addMessage(from, target, msg);\n                }\n\t\t\t});\n\t\t}\n    },\n\n    addMessage: function(from, target, content) {\n        var info = {};\n        info.msg = from + \" 对 \" + target + \" 说 : \" + content;\n        RoomInfo.chatLogs.push(info);\n        this.chatListRoot.getComponent(\"ChatListViewCtrl\").refreshList();\n    },\n\n    setTargetName: function(toName) {\n        this.toUserLabel.string = toName;\n    },\n\n    tip: function(msg) {\n        this.tipRoot.active = true;\n        if (msg) {\n            this.tipLabel.string = msg;\n        } else {\n            this.tipLabel.string = \"您有新的消息！\";\n        }\n        var act1 = cc.fadeIn(1.0);\n        var act2 = cc.fadeOut(1.0);\n        var seq = cc.sequence(act1, act2);\n        this.tipRoot.runAction(seq);\n    },\n});\n"]}